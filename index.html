<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Maze: Shifting Walls</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #ui { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 2px solid #0f0; pointer-events: none; z-index: 10; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 15px; height: 15px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); z-index: 5; }
        #win-screen { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.95); padding: 40px; border: 5px solid gold; border-radius: 30px; z-index: 100; }
        #click-to-start { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; cursor: pointer; color: white; }
        .lvl-btn { background: #0f0; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; border-radius: 10px; margin-top: 20px; font-size: 1.2em; }
    </style>
</head>
<body>

    <div id="click-to-start"><h1>üñ±Ô∏è CLICK TO START</h1><p>WASD to Move | Mouse to Look</p></div>

    <div id="ui">
        <b>üïπÔ∏è LEVEL: <span id="lvl-num">1</span></b><br>
        STATUS: <span id="wall-status" style="color:white;">STABLE</span>
    </div>

    <div id="crosshair"></div>

    <div id="win-screen">
        <h1 style="color:gold;">üèÜ LEVEL COMPLETE!</h1>
        <button class="lvl-btn" id="next-lvl-btn">NEXT LEVEL</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const winScreen = document.getElementById("win-screen");
        const startScreen = document.getElementById("click-to-start");
        const nextBtn = document.getElementById("next-lvl-btn");
        const wallStatus = document.getElementById("wall-status");

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const levels = [
            [ // Level 1 (Classic)
               [1,1,1,1,1,1,1,1],
               [1,0,0,0,0,0,0,1],
               [1,0,1,1,0,1,0,1],
               [1,0,1,0,0,1,0,1],
               [1,0,0,0,1,1,0,1],
               [1,1,1,0,0,0,2,1],
               [1,1,1,1,1,1,1,1]
            ],
            [ // Level 2 (Easier - Wide Halls)
               [1,1,1,1,1,1],
               [1,0,0,0,0,1],
               [1,0,0,0,0,1],
               [1,0,0,0,2,1],
               [1,1,1,1,1,1]
            ],
            [ // Level 3 (SHIFTING - Initial State)
               [1,1,1,1,1,1,1,1,1,1],
               [1,0,0,0,0,0,0,0,0,1],
               [1,0,1,0,1,0,1,0,0,1],
               [1,0,0,1,0,1,0,0,0,1],
               [1,0,1,0,1,0,1,0,0,1],
               [1,0,0,0,0,0,0,0,2,1],
               [1,1,1,1,1,1,1,1,1,1]
            ]
        ];

        let currentLevelIndex = 0;
        let map = levels[currentLevelIndex];
        const tileSize = 64;
        let player = { x: 96, y: 96, angle: 0 };
        let keys = {};
        let gameActive = false;

        // --- LEVEL 3 SHIFTING LOGIC ---
        function shiftWalls() {
            if (currentLevelIndex === 2) {
                wallStatus.innerText = "SHIFTING...";
                wallStatus.style.color = "red";
                
                // Randomize internal walls (not player start or goal)
                for (let y = 2; y < map.length - 2; y++) {
                    for (let x = 2; x < map[y].length - 2; x++) {
                        if (map[y][x] !== 2) {
                            map[y][x] = Math.random() > 0.7 ? 1 : 0;
                        }
                    }
                }
                
                setTimeout(() => {
                    wallStatus.innerText = "STABLE";
                    wallStatus.style.color = "white";
                }, 2000);
            }
        }
        setInterval(shiftWalls, 60000); // 1 minute

        startScreen.onclick = () => { canvas.requestPointerLock(); };
        document.addEventListener("pointerlockchange", () => {
            gameActive = (document.pointerLockElement === canvas);
            startScreen.style.display = gameActive ? "none" : "flex";
        });

        document.onmousemove = (e) => { if(gameActive) player.angle += e.movementX * 0.003; };
        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function loop() {
            if(gameActive) {
                let nx = player.x, ny = player.y;
                if(keys['w']) { nx += Math.cos(player.angle)*3.5; ny += Math.sin(player.angle)*3.5; }
                if(keys['s']) { nx -= Math.cos(player.angle)*3.5; ny -= Math.sin(player.angle)*3.5; }
                if(keys['a']) { nx += Math.sin(player.angle)*3.5; ny -= Math.cos(player.angle)*3.5; }
                if(keys['d']) { nx -= Math.sin(player.angle)*3.5; ny += Math.cos(player.angle)*3.5; }
                
                let tx = Math.floor(nx/tileSize), ty = Math.floor(ny/tileSize);
                if(map[ty] && map[ty][tx] === 0) { player.x = nx; player.y = ny; }
                else if(map[ty] && map[ty][tx] === 2) {
                    gameActive = false;
                    document.exitPointerLock();
                    winScreen.style.display = "block";
                }
            }

            ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width,canvas.height/2);
            ctx.fillStyle = "#222"; ctx.fillRect(0,canvas.height/2,canvas.width,canvas.height/2);

            const fov = Math.PI / 3, rays = canvas.width / 4;
            for(let i=0; i<rays; i++) {
                let ra = (player.angle - fov/2) + (i / rays) * fov;
                let d = 0, hit = 0;
                while(hit == 0 && d < 1000) {
                    d += 2;
                    let tx = Math.floor((player.x + Math.cos(ra)*d)/tileSize);
                    let ty = Math.floor((player.y + Math.sin(ra)*d)/tileSize);
                    if(map[ty] && map[ty][tx] > 0) hit = map[ty][tx];
                }
                let hh = (tileSize * canvas.height) / (d * Math.cos(ra - player.angle));
                let shade = Math.max(0, 255 - (d / 4));
                ctx.fillStyle = hit === 2 ? `rgb(${shade}, ${shade*0.8}, 0)` : `rgb(0, ${shade}, ${shade/3})`;
                ctx.fillRect(i*4, (canvas.height-hh)/2, 4, hh);
            }
            requestAnimationFrame(loop);
        }

        nextBtn.onclick = () => {
            currentLevelIndex++;
            if(currentLevelIndex < levels.length) {
                map = levels[currentLevelIndex];
                document.getElementById("lvl-num").innerText = currentLevelIndex + 1;
                player = { x: 96, y: 96, angle: 0 };
                winScreen.style.display = "none";
                canvas.requestPointerLock();
            } else {
                alert("MAZE MASTER!");
                location.reload();
            }
        };

        loop();
    </script>
</body>
</html>
